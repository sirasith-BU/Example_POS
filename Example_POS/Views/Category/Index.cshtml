@{
    ViewData["Title"] = "Category";
    // IEnumerable<Category> cat = ViewBag.Category;
}

<h5 id="title">Add Category</h5>
<div class="bg-dark p-2" style="border-radius:10px;">
    <div class="text-light">
        <form id="categoryForm" class="row">
            <input type="hidden" name="Id" id="edit-id"/>
            <div class="col-5">
                <label class="form-label">Name</label>
                <input class="form-control" type="text" name="Name" placeholder="Enter name" />
            </div>
            <div class="col-5">
                <label class="form-label">Description</label>
                <input class="form-control" type="text" name="Description" placeholder="Enter description" />
            </div>
            <div class="col-2 d-flex flex-column justify-content-end">
                <button type="submit" class="btn btn-primary" id="add-btn">Create</button>
                <button type="submit" class="btn btn-success d-none" id="update-btn">Update</button>
            </div>
        </form>
    </div>
</div>

<div class="mt-3">
    <form id="searchForm" class="row">
        <div class="col-5">
            <label class="form-label">Search</label>
            <input class="form-control" type="text" placeholder="Search by name" id="search" oninput="Search()"/>
        </div>
        <div class="col-7 d-flex align-items-end">
            <button class="btn btn-success">Search</button>
        </div>
    </form>
</div>

<h1 class="mt-3">Catagories</h1>
<table class="table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Description</th>
            <th>Created by</th>
            <th>Created Time</th>
            <th>Updated by</th>
            <th>Updated Time</th>
            <th>Deleted</th>
            <th>Edit</th>
            <th>Delete</th>
        </tr>
    </thead>
    <tbody id="catTableBody"></tbody>
</table>

<!-- Toasts Notifications -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" id="toastNoti">
        <div class="toast-header">
            @* <img src="..." class="rounded me-2" alt="..."> *@
            <strong class="me-auto" id="toast-header"></strong>
            @* <small>11 mins ago</small> *@
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            <p id="toast-body"></p>
        </div>
    </div>
</div>

@section Scripts
{
    <script>
        let categories = [];

        // Init data
        $(document).ready(function () {
            $.ajax({
                type: 'GET',
                url: '/Category/GetAllCategories',
                success: (response) => {
                    // categories = response;
                    console.log("Catagories", response);  

                    categories.forEach(cat_ => {
                        $('#catTableBody').append(`
                            <tr>
                                <td class="catId">${cat_.id}</td>
                                <td class="catName">${cat_.name}</td>
                                <td class="catDesc">${cat_.description}</td>
                                <td>${cat_.createBy}</td>
                                <td>${cat_.createTime}</td>
                                <td>${cat_.updateBy}</td>
                                <td>${cat_.updateTime}</td>
                                <td>
                                    <p class="fw-bold ${cat_.IsDelete == 1 ? 'text-danger' : 'text-success'}">
                                        ${cat_.IsDelete == 1 ? 'Yes' : 'No'}
                                    </p>
                                </td>
                                <td><button class="btn btn-warning edit-btn">Edit</button></td>
                                <td>
                                    <form action="/Category/Delete/${cat_.Id}" method="post">
                                        <button class="btn btn-danger">Delete</button>
                                    </form>
                                </td>
                            </tr>
                        `);
                    });
                },
                error: function (xhr, status, error) {
                    alert("Error occurred: " + xhr.responseText);
                }
            });
        });

        // Create | Update
        $('#categoryForm').on('submit', function (e) {
            e.preventDefault();

            const id = $('#edit-id').val(); // hidden id
            const name = $('input[name="Name"]').val();
            const description = $('input[name="Description"]').val();

            const isUpdate = !$('#update-btn').hasClass('d-none');

            if(isUpdate){
                $("h5#title").text("Add Category");
                $("button#add-btn").removeClass("d-none");
                $("button#update-btn").addClass("d-none");
                $('#edit-id').val(0);
                $('input[name="Name"]').val(String.empty);
                $('input[name="Description"]').val(String.empty);
            }

            const url = isUpdate ? '/Category/Update' : '/Category/Create';

            $.ajax({
                type: 'POST',
                url: url,
                data: {
                    Id: id,
                    Name: name,
                    Description: description
                },
                success: function (response) {
                    // alert("Success!");
                    if (isUpdate){
                        showToastNotifications("Update Category",response);
                    } else {
                        showToastNotifications("Add Category",response);
                    }

                    console.log(response);
                    $('#catTableBody').empty(); // Clear Table
                },
                error: function (xhr, status, error) {
                    // alert("Error occurred: " + xhr.responseText);
                    showToastNotifications("Category",xhr.responseText);
                }
            });
        });

        // Delete
        $(document).on('click', '.delete-btn', function (e) {
            e.preventDefault();

            const id = $(this).data('id');

            $.ajax({
                type: 'GET',
                url: '/Category/Delete',
                data: { Id: id },
                success: function (response) {
                    showToastNotifications("Delete Category", response);
                    $('#catTableBody').empty(); // Clear Table
                },
                error: function (xhr) {
                    showToastNotifications("Delete Error", xhr.responseText);
                }
            });
        });

        // Click for edit
        $('#catTableBody').on("click", ".edit-btn", function (e) {
            e.preventDefault();
            $("h5#title").text("Update Category");

            $("button#add-btn").addClass("d-none");
            $("button#update-btn").removeClass("d-none");

            const row = $(this).closest('tr');
            const id = row.find('td:eq(0)').text().trim();
            const name = row.find('td:eq(1)').text().trim();
            const desc = row.find('td:eq(2)').text().trim();

            $('input[name="Name"]').val(name);
            $('input[name="Description"]').val(desc);
            $('input#edit-id').val(id);
        });

        // Search
        $('#searchForm').on('submit', function (e) {
            e.preventDefault();

            const name = $('input#search').val();
            if (name !== "") {
                $.ajax({
                    type: 'GET',
                    url: "/Category/Search",
                    data: { keyword: name },
                    success: (response) => {
                    categories = response;

                    $('#catTableBody').empty(); // Clear Table
                    categories.forEach(cat_ => {
                        $('#catTableBody').append(`
                            <tr>
                                <td class="catId">${cat_.id}</td>
                                <td class="catName">${cat_.name}</td>
                                <td class="catDesc">${cat_.description}</td>
                                <td>${cat_.createBy}</td>
                                <td>${cat_.createTime}</td>
                                <td>${cat_.updateBy}</td>
                                <td>${cat_.updateTime}</td>
                                <td>
                                    <p class="fw-bold ${cat_.isDelete == 1 ? 'text-danger' : 'text-success'}">
                                        ${cat_.isDelete == 1 ? 'Yes' : 'No'}
                                    </p>
                                </td>
                                <td><button type="button" class="btn btn-warning edit-btn">Edit</button></td>
                                <td><button type="button" class="btn btn-danger delete-btn" data-id="${cat_.id}">Delete</button></td>
                            </tr>
                        `);
                    });
                },
                error: function (xhr, status, error) {
                    alert("Error occurred: " + xhr.responseText);
                }
                });
            } else
            {
               $('#catTableBody').empty(); // Clear Table
            }
        });

        function showToastNotifications(header, body)
        {
            $('#toast-header').text(header);
            $('#toast-body').text(body);
            $('#toastNoti').toast('show');
        }

        // Search Real Time
        function Search()
        {
            const name = $('input#search').val();
            if (name !== "") {
                $.ajax({
                    type: 'GET',
                    url: "/Category/Search",
                    data: { keyword: name },
                    success: (response) => {
                    categories = response;

                    $('#catTableBody').empty(); // Clear Table
                    categories.forEach(cat_ => {
                        $('#catTableBody').append(`
                            <tr>
                                <td class="catId">${cat_.id}</td>
                                <td class="catName">${cat_.name}</td>
                                <td class="catDesc">${cat_.description}</td>
                                <td>${cat_.createBy}</td>
                                <td>${cat_.createTime}</td>
                                <td>${cat_.updateBy}</td>
                                <td>${cat_.updateTime}</td>
                                <td>
                                    <p class="fw-bold ${cat_.isDelete == 1 ? 'text-danger' : 'text-success'}">
                                        ${cat_.isDelete == 1 ? 'Yes' : 'No'}
                                    </p>
                                </td>
                                <td><button type="button" class="btn btn-warning edit-btn">Edit</button></td>
                                <td><button type="button" class="btn btn-danger delete-btn" data-id="${cat_.id}">Delete</button></td>
                            </tr>
                        `);
                    });
                },
                error: function (xhr, status, error) {
                    alert("Error occurred: " + xhr.responseText);
                }
                });
            }
            else {
                $('#catTableBody').empty();
            }
        }
    </script>
}